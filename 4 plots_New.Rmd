---
title: "An Analysis of the Community Reinvestment Act"
subtitle: "An In-depth Look at Black Saber’s Practices"
author: "Report prepared for Black Saber Software"
date: "2021-04-22"
output: xaringan::moon_reader
---

class: center, middle, title-slide

# An Analysis of Biases within Hiring, Salaries, and Promotions
### An In-depth Look at Black Saber’s Practices

**Report prepared for Black Saber Software**  
*2021-04-22*

---

# Introduction
This slide deck provides an analysis of...

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r, echo = FALSE, warn.conflicts =FALSE, results = 'hide'}

library(tidyverse)
library(data.table)
library(ggplot2)
library(plotly)

```

```{r, echo = FALSE, warn.conflicts = FALSE, results = 'hide'}

local_path <- "C:/Users/sshan/Desktop/umass amherst/sta633/stat_633/"

cra_data <- read.csv(paste0(local_path, "cra_data.csv"))

transmittal_data <- read.csv(paste0(local_path, "transmittal.csv")) %>% mutate(assets = assets)

acs_data <- read.csv(paste0(local_path,"acs.csv")) %>%
  mutate(FIPS = str_pad(FIPS, width = 5, pad = "0"))

cra_assets <- left_join(cra_data, transmittal_data, by = c("resp_id", "agency", "year")) %>%
  mutate(portfolio = case_when(
      # 10b CBO
    assets <= 10000000 ~ "CBO",
      # 10b - 100b RBO
    assets > 10000000 & assets <= 100000000 ~ "RBO",
      # 100b+ LBO
    assets > 100000000 ~ "LBO"
  )) %>% select(-1, -2)

county_data <- cra_assets %>%
  group_by(year, state, county, portfolio) %>%
  summarize(num_banks = n(),
            sum_loan_amt = sum(sum_loan_amt),
            sum_n_loans = sum(sum_n_loans)) %>% 
  mutate(state = str_pad(state, width = 2, pad = "0"),
         county = str_pad(county, width = 3, pad = "0")) %>% 
  unite(FIPS, state, county, sep = "")

county_acs_data <- left_join(county_data, acs_data, by = c("year" = "Year", "FIPS"))

```


\newpage

### Introduction


```{r, echo = FALSE, warn.conflicts = FALSE,}

# https://sshannon898.shinyapps.io/stat_633/

plot1_data <- cra_assets %>%
  filter(state <= 56) %>%
  mutate(state = str_pad(state, width = 2, pad = "0")) %>% 
  group_by(year, portfolio) %>%
  summarize(n = n(),
            amt_us_sb_loans = sum(sum_loan_amt),
            n_us_sb_loans = sum(sum_n_loans))

plot1 <- ggplot(data = plot1_data) +
  geom_area(aes(x = year,
            y = amt_us_sb_loans/1000000,
            fill = portfolio, group = portfolio)) +
  theme_bw(base_size = 16) +
  labs(x = "",
       y = "Total Lending (Billions $)")

plot1

```

```{r, echo = FALSE, warn.conflicts = FALSE,}

## WITHOUT grouping by portfolio
## Also takes forever to compile, so perhaps filter out some years?
## Also I made two plots: one with a log transform and one without.

# plot2_log <- county_acs_data |>
#   filter(!is.na(sum_loan_amt), !is.na(Median_HH_Income)) |>
#   ggplot() +
#   geom_point(mapping = aes(x = log(sum_loan_amt),
#                            y = log(Median_HH_Income),
#                            color = year,
#                            text = paste0("County: ", County, "<br>Total Loan Amount: ", sum_loan_amt, "<br>Median Household Income: ", Median_HH_Income, "<br>Year:", year))) +
#   labs(x = "Log of Loan Amount Sum",
#        y = "Log of Median Household Income",
#        title = "Loan Amounts vs. Median Household Income")

# plot2 <- county_acs_data |>
#   filter(!is.na(sum_loan_amt), !is.na(Median_HH_Income)) |>
#   ggplot() +
#   geom_point(mapping = aes(x = sum_loan_amt,
#                            y = Median_HH_Income,
#                            frame = year,
#                            # color = year,
#                            text = paste0("County: ", County, "<br>Total Loan Amount: ", sum_loan_amt, "<br>Median Household Income: ", Median_HH_Income, "<br>Year:", year))) +
#   labs(x = "Loan Amount Sum",
#        y = "Median Household Income",
#        title = "Loan Amounts vs. Median Household Income") +
#   theme_bw(base_size = 16)
#  
# 
# ggplotly(plot2,
#          tooltip = "text")
# 

```

```{r, echo = FALSE, warn.conflicts = FALSE,}


plot4 <- county_acs_data |>
  group_by(year, portfolio) |>
  summarize(mean_proportion = mean(sum_loan_amt / sum_n_loans, na.rm = TRUE)) |>
  ggplot() +
  geom_point(mapping = aes(x = year,
                           y = mean_proportion,
                           group = portfolio,
                           color = portfolio,
                           text = paste0("Year: ", year, "<br>Mean Loan Amount: ", round(mean_proportion), "<br>Portfolio: ", portfolio))) +
  geom_line(mapping = aes(x = year,
                          y = mean_proportion,
                          color = portfolio)) +
  labs(x = "",
       y = "Mean Loan Amount (Thousands)") + theme_bw(base_size = 16)
 
# plot4


ggplotly(plot4,
         tooltip = "text")


```




## Plot 3


```{r} 

# Load required packages

library(RColorBrewer)


# 2. Calculate loan amount per capita
county_acs_data_temp <- county_acs_data %>%
  group_by(year) %>%
  mutate(loan_per_capita = sum_loan_amt / Population)

# 3. Classify counties into income categories using quantiles
# quantiles <- quantile(county_acs_data_temp$Median_HH_Income, probs = c(0.33, 0.66), na.rm = TRUE)
county_acs_data_temp <- county_acs_data_temp %>%
  group_by(year) %>%
  mutate(quantile_group = ntile(Median_HH_Income, 3)) %>%
  mutate(quantile_group = case_when(
    quantile_group == 1 ~ "poor",
    quantile_group == 2 ~ "middle",
    quantile_group == 3 ~ "Rich"
  ))

# 4. Group data by year and income category, then compute the average loan per capita
avg_loans <- county_acs_data %>%
  group_by(year, portfolio, income_category) %>%
  summarise(avg_loan = mean(loan_per_capita, na.rm = TRUE))


p <- ggplot(data = avg_loans,
            aes(x = year, y = avg_loan, color = income_category, group = income_category)) + 
  geom_line() +
  theme_bw(base_size = 16) +
  labs(x = "",
       y = "Avg. Loan per person") + facet_wrap(~portfolio)

p

```

"https://sshannon898.shinyapps.io/stat_633/"

